var d3 = require("d3");
var fs = require('fs');

var baseUrlGeojson = "https://digitalscholarshiplab.carto.com/api/v2/sql?format=GeoJSON&q=",
  baseUrlJson = "https://digitalscholarshiplab.carto.com/api/v2/sql?format=JSON&q=";

var queryTodo = "select distinct (statename, endcong), endcong as congress, statename from districts_1 order by congress, statename",
  queryAllDistricts = "SELECT distinct on (id) id, statename, district, startcong, endcong FROM districts";

var process = function(mapping) {
  // reorganize into lists by congress
  var congressMapping = {};
  mapping.forEach(aMapping => {
    congressMapping[parseInt(aMapping.congress)] = congressMapping[parseInt(aMapping.congress)] || [];
    congressMapping[parseInt(aMapping.congress)].push({
      current: aMapping.previous,
      next: aMapping.next
    });
  });

  console.log(congressMapping);

  var spatial_id = 0,
    spatialIds = {};
  Object.keys(congressMapping)
    .map(congressNum => parseInt(congressNum))
    .sort((a,b) => a - b)
    .forEach(congressNum => {
      // initialize for congress 1
      if (congressNum == 1) {
        congressMapping[congressNum].forEach(district => {
          spatialIds['spatialId' + spatial_id] = {};
          spatialIds['spatialId' + spatial_id][congressNum] = district.current;
          if (district.next) {
            spatialIds['spatialId' + spatial_id][congressNum + 1] = district.next;
          }
          spatial_id += 1;
        });
      } else {
        congressMapping[congressNum].forEach(district => {
          // check to see if you there's a match in the previous congress
          let previousSpatialId = false;
           Object.keys(spatialIds).forEach(spatialId => {
            if (spatialIds[spatialId][congressNum] == district.current) {
              previousSpatialId = spatialId;
            }
          });
          // if there is and there's a next district, add the latter
          if (previousSpatialId && district.next) {
            spatialIds[previousSpatialId][congressNum + 1] = district.next;
          } 
          // otherwise, create a new spatialId
          else {
            spatialIds['spatialId' + spatial_id] = {};
            spatialIds['spatialId' + spatial_id][congressNum] = district.current;
            if (district.next) {
              spatialIds['spatialId' + spatial_id][congressNum + 1] = district.next;
            }
            spatial_id += 1;
          }
        });
      }
    });

  var lookups = {};
  Object.keys(spatialIds).forEach(spatialId => {
    Object.keys(spatialIds[spatialId]).forEach(congress => {
      var year=1786 + congress * 2;
      lookups[year] = lookups[year] || {}; 
       lookups[year][spatialIds[spatialId][congress]] = spatialId;
    });
  });

  fs.writeFile("./idMap.json", JSON.stringify(lookups), function(err) {
      if(err) { return console.log(err); }
      console.log("The file was saved!");
  }); 
};

// create baseline mapping
var mapping = [],
  currentlyProcessing = [];

d3.json(baseUrlJson + queryAllDistricts, (err, d) => {
  d.rows.forEach(district => {
    for (let congress = district.startcong; congress <= district.endcong; congress++) {
      mapping.push({
        congress: congress,
        state: district.statename,
        previous: district.id,
        next: district.id
      });
    }
  });

  // make a list of congresses and states that need to be calculated
  d3.json(baseUrlJson + queryTodo, (err, d) => {
    var toDos = {};
    d.rows.forEach(toDo => {
      toDos[toDo.congress] = toDos[toDo.congress] || [];
      toDos[toDo.congress].push(toDo.statename);
    });

    // for testing, just do the first few
    // Object.keys(toDos).forEach(c => {
    //   if (c < 70 || c > 95) {
    //     delete toDos[c];
    //   }
    // });

    // iterate through each of these congresses and states producing the mappings
    Object.keys(toDos).forEach((congress, i) => {
      setTimeout(() => {
        console.log('starting Congress ' + congress);
        currentlyProcessing.push(congress);
        console.log('currently processing: ' + currentlyProcessing.join());
        congress = parseInt(congress);

        const statesArray = toDos[congress].map(state => "'" + state + "'").join(',');

        // get the percentage overlaps for each district that does intersect
        var queryOverlap = "select previous.id as previous_district, next.id as next_district, st_area(st_intersection(previous.the_geom, next.the_geom))/st_area(previous.the_geom) as overlap from (SELECT distinct on (id) id, cartodb_id, st_makevalid(the_geom) as the_geom, statename  FROM districts_1 where endcong =  " + congress + " and statename in (" + statesArray + ") and district != 0) previous join (SELECT distinct on (id) id, cartodb_id, st_makevalid(the_geom) as the_geom, statename FROM districts_1 where startcong =  " + (congress + 1) + " and statename in (" + statesArray + ") and district != 0) next on previous.statename = next.statename and st_intersects(ST_CollectionExtract(previous.the_geom,3), ST_CollectionExtract(next.the_geom,3)) and  st_area(st_intersection(previous.the_geom, next.the_geom))/st_area(previous.the_geom) > 0.05 order by overlap desc";
        
        d3.json(baseUrlJson + queryOverlap, (err, cd) => {
          if (!cd || cd.length == 0) { console.log(queryOverlap, err, cd); }
          if (cd && cd.rows) {
            // get the district ids that need to be mapped and initiate a mapping object
            var currentDistrictLists = Array.from(new Set(cd.rows.map(intersection => intersection.previous_district))),
              candidatesList = Array.from(new Set(cd.rows.map(intersection => intersection.next_district))),
              currentDistrictsMapping = currentDistrictLists.map(num => { 
                return {
                  congress: congress, 
                  previous: num, 
                  next: null
                }; 
              });

            // iterate through the results one by one assigning candidates
            cd.rows.forEach(intersection => {
              if (currentDistrictLists.length > 0 && candidatesList.length > 0 && currentDistrictLists.includes(intersection.previous_district)) {
                var i = currentDistrictsMapping.findIndex(d => d.previous == intersection.previous_district);
                // map the best candidate
                if (candidatesList.includes(intersection.next_district)) {
                  currentDistrictsMapping[i].next = intersection.next_district;
                  // remove the current district and the chosen candidate from their respective lists 
                  currentDistrictLists = currentDistrictLists.filter(id => id != intersection.previous_district);
                  candidatesList = candidatesList.filter(id => id != intersection.next_district);
                }
              }
            });

            mapping = mapping.concat(currentDistrictsMapping);
            console.log("finished Congress " + congress);

            // remove from the toDo list
            currentlyProcessing = currentlyProcessing.filter(c => c != congress);
            delete toDos[congress];
            console.log((Object.keys(toDos).length > 0) ? 'Remaining: ' + Object.keys(toDos).join() : 'FINISHED CANDIDATE SELECTION -- BEGINNING PROCESSING');

            if (Object.keys(toDos).length == 0) {
              process(mapping);
            }
          }
        });
      }, 2500 * i);
    });
  });
});









  // d3.json(baseUrlJson + queryChangedStates, (err, cd) => {
  //   if (cd.rows) {
  //     var changedStates= cd.rows.map(s => s.statename);

  //     changedStates.forEach(state => {
  //       // queryChangedFrom = "SELECT distinct on (id) id, cartodb_id, the_geom, statename, district, startcong, endcong FROM digitalscholarshiplab.congressional_districts where endcong =  " + congressNum + " and statename = '" + state + "'";
  //       // console.log(queryChangedFrom);


  //     });

      

  //   }
// });

  // queryUnchanged = "SELECT distinct on (id) id, cartodb_id, the_geom, statename, district, startcong, endcong FROM congressional_districts where startcong <= " + congressNum +" and endcong >=  " + (congressNum + 1),
  // queryChangedStates = "SELECT distinct (statename) FROM digitalscholarshiplab.congressional_districts where endcong = " + congressNum,
  // queryChanged = "SELECT distinct on (id) id, cartodb_id, the_geom, statename, district, startcong, endcong FROM digitalscholarshiplab.congressional_districts where endcong =  " + congressNum,
  // queryChangedTo = "SELECT distinct on (id) id, cartodb_id, the_geom, statename, district, startcong, endcong FROM digitalscholarshiplab.congressional_districts where startcong =  " + (congressNum + 1);

